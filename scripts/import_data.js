#!/usr/bin/env node

/**
 * StudyBuddy Data Import Script (Node.js version)
 * S·ª≠ d·ª•ng: node scripts/import_data.js
 */

const admin = require('firebase-admin');
const fs = require('fs');
const path = require('path');

class StudyBuddyDataImporter {
    constructor(serviceAccountPath = null) {
        if (serviceAccountPath && fs.existsSync(serviceAccountPath)) {
            // S·ª≠ d·ª•ng service account file
            const serviceAccount = require(path.resolve(serviceAccountPath));
            admin.initializeApp({
                credential: admin.credential.cert(serviceAccount)
            });
        } else {
            // S·ª≠ d·ª•ng default credentials
            admin.initializeApp();
        }
        
        this.db = admin.firestore();
        console.log('‚úÖ ƒê√£ k·∫øt n·ªëi Firebase th√†nh c√¥ng!');
    }

    async importTasks(tasksData) {
        console.log(`üìù ƒêang import ${tasksData.length} tasks...`);
        
        const batch = this.db.batch();
        const tasksRef = this.db.collection('tasks');
        
        for (const taskData of tasksData) {
            const docRef = tasksRef.doc();
            
            const firestoreData = {
                id: docRef.id,
                title: taskData.title,
                description: taskData.description || null,
                subject: taskData.subject,
                deadline: taskData.deadline,
                isCompleted: taskData.isCompleted,
                priority: taskData.priority,
                createdAt: taskData.createdAt,
                completedAt: taskData.completedAt || null
            };
            
            batch.set(docRef, firestoreData);
        }
        
        await batch.commit();
        console.log(`‚úÖ ƒê√£ import ${tasksData.length} tasks th√†nh c√¥ng!`);
    }

    async importEvents(eventsData) {
        console.log(`üìÖ ƒêang import ${eventsData.length} events...`);
        
        const batch = this.db.batch();
        const eventsRef = this.db.collection('events');
        
        for (const eventData of eventsData) {
            const docRef = eventsRef.doc();
            
            const firestoreData = {
                id: docRef.id,
                title: eventData.title,
                description: eventData.description || null,
                startTime: eventData.startTime,
                endTime: eventData.endTime,
                type: eventData.type,
                subject: eventData.subject || null,
                location: eventData.location || null,
                isAllDay: eventData.isAllDay,
                color: eventData.color
            };
            
            batch.set(docRef, firestoreData);
        }
        
        await batch.commit();
        console.log(`‚úÖ ƒê√£ import ${eventsData.length} events th√†nh c√¥ng!`);
    }

    async importUsers(usersData) {
        console.log(`üë§ ƒêang import ${usersData.length} users...`);
        
        const batch = this.db.batch();
        const usersRef = this.db.collection('users');
        
        for (const userData of usersData) {
            const docRef = usersRef.doc();
            
            const firestoreData = {
                id: docRef.id,
                name: userData.name,
                email: userData.email,
                avatar: userData.avatar || null,
                grade: userData.grade || null,
                school: userData.school || null,
                createdAt: userData.createdAt,
                lastLoginAt: userData.lastLoginAt || null
            };
            
            batch.set(docRef, firestoreData);
        }
        
        await batch.commit();
        console.log(`‚úÖ ƒê√£ import ${usersData.length} users th√†nh c√¥ng!`);
    }

    async clearCollection(collectionName) {
        console.log(`üóëÔ∏è ƒêang x√≥a collection '${collectionName}'...`);
        
        const snapshot = await this.db.collection(collectionName).get();
        const batch = this.db.batch();
        
        snapshot.docs.forEach((doc) => {
            batch.delete(doc.ref);
        });
        
        await batch.commit();
        console.log(`‚úÖ ƒê√£ x√≥a collection '${collectionName}' th√†nh c√¥ng!`);
    }

    getSampleData() {
        const now = new Date();
        
        // Sample Tasks
        const tasks = [
            {
                title: 'L√†m b√†i t·∫≠p To√°n ch∆∞∆°ng 3',
                description: 'Ho√†n th√†nh c√°c b√†i t·∫≠p t·ª´ trang 45-50 trong s√°ch gi√°o khoa',
                subject: 'To√°n',
                deadline: new Date(now.getTime() + 2 * 24 * 60 * 60 * 1000).toISOString(),
                isCompleted: false,
                priority: 2,
                createdAt: new Date(now.getTime() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                completedAt: null
            },
            {
                title: '√în t·∫≠p t·ª´ v·ª±ng ti·∫øng Anh',
                description: 'H·ªçc 50 t·ª´ m·ªõi trong Unit 5 v√† l√†m b√†i t·∫≠p vocabulary',
                subject: 'Anh',
                deadline: new Date(now.getTime() + 1 * 24 * 60 * 60 * 1000).toISOString(),
                isCompleted: true,
                priority: 1,
                createdAt: new Date(now.getTime() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                completedAt: new Date(now.getTime() - 2 * 60 * 60 * 1000).toISOString()
            },
            {
                title: 'ƒê·ªçc s√°ch VƒÉn h·ªçc',
                description: 'ƒê·ªçc v√† ph√¢n t√≠ch t√°c ph·∫©m "Truy·ªán Ki·ªÅu" c·ªßa Nguy·ªÖn Du',
                subject: 'VƒÉn',
                deadline: new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000).toISOString(),
                isCompleted: false,
                priority: 3,
                createdAt: new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000).toISOString(),
                completedAt: null
            },
            {
                title: 'L√†m th√≠ nghi·ªám H√≥a h·ªçc',
                description: 'Th·ª±c h√†nh th√≠ nghi·ªám v·ªÅ ph·∫£n ·ª©ng oxi h√≥a kh·ª≠ trong ph√≤ng lab',
                subject: 'H√≥a',
                deadline: new Date(now.getTime() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                isCompleted: false,
                priority: 1,
                createdAt: new Date(now.getTime() - 4 * 24 * 60 * 60 * 1000).toISOString(),
                completedAt: null
            },
            {
                title: 'H·ªçc l√Ω thuy·∫øt V·∫≠t l√Ω',
                description: '√în t·∫≠p ch∆∞∆°ng ƒëi·ªán h·ªçc v√† t·ª´ h·ªçc, chu·∫©n b·ªã cho b√†i ki·ªÉm tra',
                subject: 'L√Ω',
                deadline: new Date(now.getTime() + 5 * 24 * 60 * 60 * 1000).toISOString(),
                isCompleted: false,
                priority: 2,
                createdAt: new Date(now.getTime() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                completedAt: null
            }
        ];

        // Sample Events
        const events = [
            {
                title: 'H·ªçc To√°n',
                description: '√în t·∫≠p ch∆∞∆°ng 3 v·ªÅ ƒë·∫°o h√†m v√† ·ª©ng d·ª•ng',
                startTime: new Date(now.getTime() + 2 * 60 * 60 * 1000).toISOString(),
                endTime: new Date(now.getTime() + 4 * 60 * 60 * 1000).toISOString(),
                type: 'study',
                subject: 'To√°n',
                location: 'Th∆∞ vi·ªán tr∆∞·ªùng',
                isAllDay: false,
                color: '#FF6B6B'
            },
            {
                title: 'Ki·ªÉm tra VƒÉn',
                description: 'Ki·ªÉm tra 15 ph√∫t v·ªÅ t√°c ph·∫©m vƒÉn h·ªçc',
                startTime: new Date(now.getTime() + 24 * 60 * 60 * 1000 + 8 * 60 * 60 * 1000).toISOString(),
                endTime: new Date(now.getTime() + 24 * 60 * 60 * 1000 + 8 * 60 * 60 * 1000 + 15 * 60 * 1000).toISOString(),
                type: 'exam',
                subject: 'VƒÉn',
                location: 'L·ªõp 12A1',
                isAllDay: false,
                color: '#4ECDC4'
            },
            {
                title: 'Nh√≥m h·ªçc t·∫≠p',
                description: 'Th·∫£o lu·∫≠n nh√≥m v·ªÅ b√†i t·∫≠p H√≥a h·ªçc',
                startTime: new Date(now.getTime() + 2 * 24 * 60 * 60 * 1000 + 14 * 60 * 60 * 1000).toISOString(),
                endTime: new Date(now.getTime() + 2 * 24 * 60 * 60 * 1000 + 16 * 60 * 60 * 1000).toISOString(),
                type: 'study',
                subject: 'H√≥a',
                location: 'Ph√≤ng h·ªçc nh√≥m',
                isAllDay: false,
                color: '#45B7D1'
            }
        ];

        // Sample Users
        const users = [
            {
                name: 'Nguy·ªÖn VƒÉn An',
                email: 'an.nguyen@example.com',
                avatar: 'https://example.com/avatar1.jpg',
                grade: '12',
                school: 'THPT Chuy√™n H√† N·ªôi - Amsterdam',
                createdAt: new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString(),
                lastLoginAt: now.toISOString()
            },
            {
                name: 'Tr·∫ßn Th·ªã B√¨nh',
                email: 'binh.tran@example.com',
                avatar: 'https://example.com/avatar2.jpg',
                grade: '12',
                school: 'THPT Chuy√™n H√† N·ªôi - Amsterdam',
                createdAt: new Date(now.getTime() - 25 * 24 * 60 * 60 * 1000).toISOString(),
                lastLoginAt: new Date(now.getTime() - 2 * 60 * 60 * 1000).toISOString()
            },
            {
                name: 'L√™ Ho√†ng C∆∞·ªùng',
                email: 'cuong.le@example.com',
                avatar: 'https://example.com/avatar3.jpg',
                grade: '12',
                school: 'THPT Chuy√™n H√† N·ªôi - Amsterdam',
                createdAt: new Date(now.getTime() - 20 * 24 * 60 * 60 * 1000).toISOString(),
                lastLoginAt: new Date(now.getTime() - 5 * 60 * 60 * 1000).toISOString()
            }
        ];

        return {
            tasks,
            events,
            users
        };
    }
}

async function main() {
    console.log('üöÄ B·∫Øt ƒë·∫ßu import data v√†o Firebase...');
    console.log('='.repeat(50));
    
    try {
        // Kh·ªüi t·∫°o importer
        const serviceAccountPath = null; // "path/to/serviceAccountKey.json"
        const importer = new StudyBuddyDataImporter(serviceAccountPath);
        
        // L·∫•y sample data
        const sampleData = importer.getSampleData();
        
        // H·ªèi user c√≥ mu·ªën x√≥a data c≈© kh√¥ng
        const readline = require('readline');
        const rl = readline.createInterface({
            input: process.stdin,
            output: process.stdout
        });
        
        const clearOld = await new Promise((resolve) => {
            rl.question('üóëÔ∏è C√≥ mu·ªën x√≥a data c≈© kh√¥ng? (y/N): ', (answer) => {
                resolve(answer.toLowerCase().trim() === 'y');
                rl.close();
            });
        });
        
        if (clearOld) {
            console.log('üóëÔ∏è ƒêang x√≥a data c≈©...');
            await importer.clearCollection('tasks');
            await importer.clearCollection('events');
            await importer.clearCollection('users');
            console.log('‚úÖ ƒê√£ x√≥a data c≈© th√†nh c√¥ng!');
        }
        
        // Import data
        console.log('\nüìä B·∫Øt ƒë·∫ßu import data...');
        await importer.importTasks(sampleData.tasks);
        await importer.importEvents(sampleData.events);
        await importer.importUsers(sampleData.users);
        
        console.log('\nüéâ Import data th√†nh c√¥ng!');
        console.log('='.repeat(50));
        console.log('üìù ƒê√£ import:');
        console.log(`   - ${sampleData.tasks.length} tasks`);
        console.log(`   - ${sampleData.events.length} events`);
        console.log(`   - ${sampleData.users.length} users`);
        console.log('='.repeat(50));
        
    } catch (error) {
        console.error(`‚ùå L·ªói: ${error.message}`);
        process.exit(1);
    }
}

if (require.main === module) {
    main();
}

module.exports = StudyBuddyDataImporter; 